<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="top.orosirian.orodisk.mappers.AiMessageMapper">

    <resultMap id="BaseResultMap" type="top.orosirian.orodisk.model.entity.AiMessage">
        <id column="message_id" property="messageId"/>
        <result column="conversation_id" property="conversationId"/>
        <result column="role" property="role"/>
        <result column="content" property="content"/>
        <result column="token_count" property="tokenCount"/>
        <result column="created_time" property="createdTime"/>
    </resultMap>

    <sql id="Base_Column_List">
        message_id, conversation_id, role, content, token_count, created_time
    </sql>

    <insert id="insert" parameterType="top.orosirian.orodisk.model.entity.AiMessage" useGeneratedKeys="true" keyProperty="messageId">
        INSERT INTO ai_message (conversation_id, role, content, token_count)
        VALUES (#{conversationId}, #{role}, #{content}, #{tokenCount})
    </insert>

    <delete id="deleteByConversationId">
        DELETE FROM ai_message
        WHERE conversation_id = #{conversationId}
    </delete>

    <select id="selectByConversationId" resultMap="BaseResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM ai_message
        WHERE conversation_id = #{conversationId}
        ORDER BY created_time
        <if test="limit != null">
            LIMIT #{limit}
        </if>
    </select>

    <select id="selectLastByConversationId" resultMap="BaseResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM ai_message
        WHERE conversation_id = #{conversationId}
        ORDER BY created_time DESC
        LIMIT 1
    </select>

</mapper>
